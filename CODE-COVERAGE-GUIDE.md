# Code Coverage Guide

## Quick Start

### Option 1: Using PowerShell (Windows - Recommended)
```powershell
.\generate-coverage.ps1
```

### Option 2: Using Batch File (Windows)
```cmd
generate-coverage.bat
```

### Option 3: Using Bash (Linux/macOS)
```bash
chmod +x generate-coverage.sh
./generate-coverage.sh
```

## What These Scripts Do

1. **Clean** previous coverage reports
2. **Run** all tests with code coverage collection (using `coverlet.runsettings`)
3. **Filter** out generated code and infrastructure (Program.cs, OpenAPI generated code, etc.)
4. **Generate** an HTML report with detailed coverage metrics
5. **Open** the report automatically in your browser

## Exclusions

The following are automatically excluded from coverage reports:

### By Configuration (`coverlet.runsettings`)
- ? Test projects (`*.Tests`)
- ? Program.cs
- ? Migrations
- ? Generated files (`*.Generated.cs`)
- ? OpenAPI generated code (`Microsoft.AspNetCore.OpenApi.Generated`)
- ? Compiler generated code (`System.Runtime.CompilerServices`)

### By Attribute
- ? `[ExcludeFromCodeCoverage]`
- ? `[GeneratedCode]`
- ? `[CompilerGenerated]`
- ? `[Obsolete]`

### Why Exclude These?

- **Program.cs**: Infrastructure/startup code, difficult to unit test
- **Generated Code**: Auto-generated by tools, not written by developers
- **Migrations**: Database schema changes, tested separately
- **Test Projects**: Tests themselves shouldn't be included in coverage

## First Time Setup

The scripts will automatically install `dotnet-reportgenerator-globaltool` if needed, but you can install it manually:

```sh
dotnet tool install -g dotnet-reportgenerator-globaltool
```

## Manual Commands

### Run Tests with Coverage
```sh
# Basic coverage
dotnet test --collect:"XPlat Code Coverage"

# With specific output directory
dotnet test --collect:"XPlat Code Coverage" --results-directory:"TestResults"

# With custom settings
dotnet test --settings coverlet.runsettings
```

### Generate HTML Report Manually
```sh
# After running tests
reportgenerator -reports:"TestResults/**/coverage.cobertura.xml" -targetdir:"coveragereport" -reporttypes:"Html;HtmlSummary;Badges"

# Open the report
start coveragereport/index.html  # Windows
open coveragereport/index.html   # macOS
xdg-open coveragereport/index.html  # Linux
```

### Coverage with Threshold Check
```sh
# Fail if coverage drops below 80%
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=cobertura /p:Threshold=80 /p:ThresholdType=line
```

## Understanding the Report

The HTML report shows:

- **Line Coverage**: Percentage of code lines executed during tests
- **Branch Coverage**: Percentage of code branches (if/else) executed
- **Method Coverage**: Percentage of methods executed
- **Class Coverage**: Percentage of classes that have at least one test

### Coverage Levels
- ?? **90-100%**: Excellent
- ?? **80-89%**: Good
- ?? **70-79%**: Fair
- ?? **<70%**: Needs Improvement

## Report Features

### In the HTML Report:
- **Summary Page**: Overall project coverage
- **Assembly Drill-down**: Click on assemblies to see namespace coverage
- **Class Drill-down**: Click on classes to see method coverage
- **Line-by-line View**: Green = covered, Red = not covered
- **Sortable Tables**: Click column headers to sort
- **Filter Options**: Filter by coverage percentage
- **Risk Hotspots**: Identifies complex, untested code

## Customizing Coverage Settings

Edit `coverlet.runsettings` to customize:

```xml
<Configuration>
  <!-- Exclude specific patterns -->
  <Exclude>[*.Tests]*,[*]*.Program</Exclude>
  
  <!-- Exclude by attribute -->
  <ExcludeByAttribute>Obsolete,GeneratedCodeAttribute</ExcludeByAttribute>
  
  <!-- Include/exclude test assemblies -->
  <IncludeTestAssembly>false</IncludeTestAssembly>
</Configuration>
```

Then run with:
```sh
dotnet test --settings coverlet.runsettings
```

## CI/CD Integration

### GitHub Actions Example
```yaml
- name: Test with Coverage
  run: dotnet test --collect:"XPlat Code Coverage"

- name: Upload Coverage
  uses: codecov/codecov-action@v3
  with:
    files: '**/coverage.cobertura.xml'
```

### Azure DevOps Example
```yaml
- task: DotNetCoreCLI@2
  inputs:
    command: 'test'
    arguments: '--collect:"XPlat Code Coverage"'
  
- task: PublishCodeCoverageResults@1
  inputs:
    codeCoverageTool: 'Cobertura'
    summaryFileLocation: '**/coverage.cobertura.xml'
```

## VS Code Integration

### Install Coverage Gutters Extension
1. Install **Coverage Gutters** from VS Code Marketplace
2. Run coverage with lcov format:
```sh
dotnet test --collect:"XPlat Code Coverage" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=lcov
```
3. Click **Watch** in VS Code status bar
4. See coverage inline in your code!

## Visual Studio Integration

### Built-in Coverage
1. **Test** menu ? **Analyze Code Coverage** ? **All Tests**
2. View results in **Code Coverage Results** window

### Fine Code Coverage Extension
1. Install **Fine Code Coverage** from VS Marketplace
2. Run tests normally
3. View real-time coverage in **Coverage** window

## Troubleshooting

### "reportgenerator command not found"
```sh
dotnet tool install -g dotnet-reportgenerator-globaltool
```

### "Cannot run scripts" (PowerShell)
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### "Permission denied" (Bash)
```bash
chmod +x generate-coverage.sh
```

### Coverage report is empty
- Ensure tests are actually running
- Check that test project references the main project
- Verify `coverlet.runsettings` exclusions aren't too broad

### Tests pass but coverage fails
- Check coverage threshold settings
- Review which code is being excluded

## Quick Commands Reference

```sh
# Run tests and open coverage report
.\generate-coverage.ps1

# Run tests only (no report)
dotnet test

# Run with coverage (console output)
dotnet test /p:CollectCoverage=true

# Run specific test
dotnet test --filter "FullyQualifiedName~ClassName"

# Run tests with verbose output
dotnet test --verbosity normal

# Clean, build, and test
dotnet clean && dotnet build && dotnet test

# Coverage with threshold
dotnet test /p:CollectCoverage=true /p:Threshold=80
```

## Coverage Goals

For this project:
- **Minimum**: 80% line coverage
- **Target**: 90% line coverage
- **Critical Paths**: 100% coverage
- **New Code**: Must maintain or improve coverage

## Best Practices

1. ? Run coverage before committing
2. ? Never decrease overall coverage
3. ? Focus on critical business logic first
4. ? Don't aim for 100% everywhere (diminishing returns)
5. ? Test behavior, not implementation
6. ? Use coverage to find untested code paths
7. ? Review coverage reports in code reviews

## Files Created

- `generate-coverage.ps1` - PowerShell script (Windows)
- `generate-coverage.bat` - Batch file (Windows)
- `generate-coverage.sh` - Bash script (Linux/macOS)
- `coverlet.runsettings` - Coverage configuration
- `.gitignore` - Updated with coverage paths

## Additional Resources

- [Coverlet Documentation](https://github.com/coverlet-coverage/coverlet)
- [ReportGenerator Documentation](https://github.com/danielpalme/ReportGenerator)
- [Code Coverage Best Practices](https://martinfowler.com/bliki/TestCoverage.html)

---

**Last Updated**: 2024
**Coverage Tool**: Coverlet (XPlat Code Coverage)
**Report Generator**: ReportGenerator
